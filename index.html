<html>
<head>
	<title>Better Course Explorer</title>
	<script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
	<link href="elements/registration-app.html" rel="import" />
	<script type="text/javascript">
	window.Updator = require('updator');
	Updator.check();
	</script>
	<script type="text/javascript">
	console.log("Main frame loaded.");
	Catalog = require('catalog');
	Bookmark = require('bookmark');
	if (!localStorage.getItem('index')) {
		// location.assign('data-helper.html#autorestore');
		window.catalog = new Catalog([], [], " ");
		window.bookmark = new Bookmark([]);
		window.addEventListener("load", () => {
			// Launch db wizard
			document.querySelector("sidebar-element").selected = 2; // Settings
			document.querySelector("main-window-settings").page = "database";
			document.querySelector("uiuc-settings-database").initwizard();

		});
	} else {
		console.log("Loading catalog...");
		Catalog.inst = Catalog.fromLocalStorage(); // TODO
		window.catalog = Catalog.inst;
		if (!localStorage.getItem("bookmark")) {
			localStorage.setItem("bookmark", "{}");
		}
		window.bookmark = Bookmark.fromStorage(localStorage);
		console.log("Catalog loaded.");
	}
	</script>
	<script type="text/javascript">
	// Regbot
	window.regbot = {
		pref: null,
		inst: null,
		wnd: null,
		webview: null
	};
	regbot.activate = function() {
		if (regbot.inst) {
			console.warn("RegBot is already running");
			return;
		}
		regbot.wnd = window.open("regbot.html");
		regbot.wnd.addEventListener("load", function() {
			regbot.boot();
		});
		regbot.wnd.addEventListener("unload", function() {
			regbot.shutdown();
		});
	}
	regbot.boot = function() {
		regbot.webview = regbot.wnd.document.getElementById("webview");
		regbot.inst = new RegWebview(regbot.pref, regbot.webview);
		regbot.pref.enabled = true;
	}
	regbot.deactivate = function() {
		if (!regbot.inst) {
			console.warn("RegBot is not running");
			return;
		}
		regbot.wnd.close();
	}
	regbot.shutdown = function() {
		regbot.webview = null;
		regbot.wnd = null;
		regbot.inst = null;
		regbot.pref.enabled = false;
	}

	(function() {
		var jsonpref = localStorage.getItem("regbot");
		if (!jsonpref) {
			regbot.pref = {
				showinfo: true,
				enabled: false,
				autoload: false,
				autologin: false,
				username: "",
				password: ""
			};
		} else {
			regbot.pref = JSON.parse(jsonpref);
		}
		if (regbot.pref.enabled) {
			regbot.activate();
		}
	})();
	</script>
</head>
<body fullbleed unresolved>
	<registration-app></registration-app>
</body>
