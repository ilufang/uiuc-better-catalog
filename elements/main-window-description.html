<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="main-section-info.html">

<style is="custom-style">
:root{
	paper-toolbar{
		--paper-toolbar-title:{
			font-size:20pt;
			height:auto;
		};
	}
}
</style>

<dom-module id="main-window-description">
	<template>
		<style type="text/css">
			:host {
				font-family: sans-serif;
			}
			#toolbar-title {
				margin-left: 0px;
				font-weight: bold;
			}
			#description {
				font-size: 1.2em;
			}
			#container {
				margin: 1em;
			}
			#sync {
				opacity: 0.6;
				transform: scale(0.6,0.6);
				transform-origin: left top;
			}
		</style>
		<paper-header-panel mode="waterfall" shadow>
			<paper-toolbar class="tall" id="header-toolbar">
				<span class="top" id="sync">
					<iron-icon icon="[[syncicon]]"></iron-icon>
					<i id="syncstatus">[[syncstatus]]</i>
				</span>
				<span class="middle" id="toolbar-sub"></span>
				<span class="bottom title" id="toolbar-title">[[name]]</span>
			</paper-toolbar>
			<div style="display: none" id="container">
				<strong style="color:#00f">[[credit]]</strong>
				<p class="content fit" id="description"></p>
				<hr />
				<div class="content fit" id="requirements"></div>
				<hr />
				<div class="content fit" id="sections"></div>
			</div>
		</paper-header-panel>
	</template>
	<script>
	Polymer({
		is: "main-window-description",
		properties: {
			course: {
				type: String,
				notify: true,
				reflectToAttribute: true,
				observer: "setCourse"
			},
			courseobj: Object,
			dept: String,
			credit: String,
			name: {
				type: String,
				value: "UIUC Improved Course Explorer"
			},
			sync: String,
			syncicon: String,
			syncstatus: String
		},
		ready: function(e){
		},
		setCourse: function(code, prev) {
			if (code == prev) {
				return;
			}
			var course = catalog.getCourse(code);
			if (!course) {
				return;
			}
			if (this.courseobj && this.courseobj.code == course.code) {
				return;
			}

			this.inflateCourse(course, 'setCourse');

			// Trigger auto-sync
			if (this.sync != course.code) {
				this.sync = course.code;
				this.syncicon = 'cloud-queue';
				this.syncstatus = 'Updating...';
				catalog.update(code).then(((data) => {
					this.inflateCourse(data, 'update');
				}).bind(this), (err) => {
					console.error(err);
					this.sync = 'err';
					this.syncicon = 'error';
					this.syncstatus = err;
				});
			}
		},
		inflateCourse: function(course, src) {
			if (src=='update') {
				if (course.code != this.courseobj.code) {
					// Outdated update, do not inflate
					return;
				}
				this.sync = '';
				this.syncicon = 'cloud-done';
				this.syncstatus = 'Up to date!';

				// Preserve open/close status of sections
				var section_expanded = {};
				this.$.sections.querySelectorAll('main-section-group').forEach((section) => {
					section_expanded[section.type] = !section.contentsHidden;
				});

			}

			// Colorize!
			var hue = 0;
			for (var i=0; i<course.dept.length; ++i) {
				hue += course.dept.charCodeAt(i);
			}
			hue %= 20;
			hue *= 18;
			this.$['header-toolbar'].style.background = `hsl(${hue},100%,40%)`;

			this.courseobj = course;
			this.$.container.style.display = '';

			this.dept = catalog.courses[course.dept].name;
			this.name = course.title;
			this.$['toolbar-sub'].innerText = course.dept + ' ' + course.number + ' | ' + this.dept;
			this.$.description.innerHTML = course.description;
			this.$.description.querySelectorAll("a").forEach((a_course, idx, arr) => {
				arr[idx].href="#";
				a_course.addEventListener("click", (function() {
					this.course = a_course.innerText;
				}).bind(this));
			});

			this.$.requirements.innerHTML='';
			course.requirements.raw.forEach((line) => {
				this.$.requirements.innerHTML += "<p>"+line+"</p>\n";
			});
			this.$.requirements.querySelectorAll("a").forEach((a_course, idx, arr) => {
				arr[idx].href="#";
				a_course.addEventListener("click", (function() {
					this.course = a_course.innerText;
				}).bind(this));
			});
			this.credit = course.getCredit();

			// Inflate sections
			this.$.sections.innerHTML = '';
			for (var type in course.sections) {
				var secblock = document.createElement("main-section-group");
				secblock.course = course.code;
				secblock.type = type;
				if (src=='update' && section_expanded[type]) {
					secblock.contentsHidden = false;
				}
				this.$.sections.appendChild(secblock);
			}
		}
	});
	</script>

</dom-module>
</html>
