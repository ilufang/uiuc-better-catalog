<!DOCTYPE html>
<html>
<head>
	<link rel="import" href="../bower_components/polymer/polymer.html">
	<link rel="import" href="../bower_components/paper-input/paper-input.html">
	<link rel="import" href="../bower_components/paper-material/paper-material.html">
	<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
	<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
	<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

	<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
</head>

<script type="text/javascript">
function generateCourseCell(course) {
	var cell = document.createElement('sidebar-search-result-cell');
	cell.caption = course.code;
	var description = `${course.title}<br><i>${course.getCredit()}</i>`;
	cell.description = description;
	return cell;
}
// For relevance: decide whether two words are similar enough to be considered equal
// Corrects spelling mistakes and word variants, like plural
// Algorithm: find the longest shared part, same "move & match" algorithm as relevance
function similar(a, b){
	if (a==b)
		return true;
	if (!a || !b)
		return false;
	var len = a.length / b.length;
	if (len > 2 || len < 0.5 || a.length<5 || b.length<5)
		return false;
	var current = 0, longest = 0;
	for (var i=0; i<a.length; i++) {
		current = 0;
		for (var j=0; j<b.length; j++) {
			if (a[i+j] == b[j]) {
				++current;
				if (current > longest)
					longest = current;
			} else {
				current = 0;
			}
		}
	}
	if (4 * longest > a.length + b.length)
		return true;
	else
		return false;
}
// For searchbox: calculate similarity between text and search word
// Algorithm: move the needle along the haystack, sum up the squared length of the longest common substring for each position
function relevance(haystack, needle) {
	if (haystack.trim() == needle.trim())
		return 100; // Prefect match
	var emptyword = /( |^)(the|\&|and|a|an|with|of|in|to|from|for|I|II|III)( |$)/g;
	haystack = haystack.toLowerCase().replace(emptyword," ").split(' ');
	needle = needle.toLowerCase().replace(emptyword," ").split(' ');
	var score = 0;
	for (var i=0; i<haystack.length; ++i) {
		var longest = 0, current = 0;
		for (var j=0; j<needle.length; ++j) {
			if (similar(needle[j], haystack[i+j])) {
				++longest;
				if (current > longest)
					longest = current;
			} else {
				current = 0;
			}
		}
		score += longest*longest;
	}
	return score/(needle.length*needle.length);
}
</script>

<dom-module id="sidebar-search-result-cell">
	<template>
		<style type="text/css">
		:host {
			display: block;
			position: relative;
			margin: 0px;
			padding: 0px;
			cursor: pointer;
			font-family: sans-serif;
			border-top: 1px solid #ccc;
			background: #fff;
			transition: background 0.2s;
			user-select: none;
			-webkit-user-select: none;
		};
		:host:hover {
			background-color: #eee;
		}
		strong#caption {
			font-size: 1.2em;
			margin-bottom: 0.3em;
		}
		p#content {
			color: #666;
			margin: 0px;
		}
		</style>
		<div style="padding: 0.8em" id="main">
			<strong id='caption'>[[caption]]</strong>
			<p id='content'></p>
		</div>
		<paper-ripple id="ripple"></paper-ripple>
	</template>
	<script type="text/javascript">
	Polymer({
		is: "sidebar-search-result-cell",
		properties: {
			caption: {
				type: String,
				reflectToAttribute: true
			},
			description: {
				type: String,
				reflectToAttribute: true,
				notify: true,
				observer: "setContent"
			},
			value: {
				type: String,
				reflectToAttribute: true
			},
			disabled: {
				type: Boolean,
				reflectToAttribute: true,
				notify: true,
				observer: "disableElement"
			}
		},
		setContent: function(content) {
			this.$.content.innerHTML = content;
		},
		ready: function(e) {
			this.listen(this.$.main, "tap", "clicked");
		},
		clicked: function() {
			var keyword = this.value;
			if (!keyword || keyword.length==0) {
				keyword = this.caption;
			}
			this.fire("cell-clicked", {keyword});
		}
	});
	</script>
</dom-module>

<dom-module id="sidebar-element-browse">
	<template>
		<style is="custom-style" include="iron-flex iron-flex-alignment"></style>
		<style type="text/css">
		:host {
			height: 100%;
		}
		#main {
			height: 100%;
		}
		#main>paper-material {
			z-index: 100;
		}
		#results {
			overflow: auto;
		}
		paper-input {
			/* Tricking css: passing invalid value defaults everything to browser default: no border with visible placeholder text */
			--paper-input-container-color: none;
			--paper-input-container-focus-color: none;
		}
		#searchbox_btn {
			--paper-icon-button-disabled-text: #000;
		}
		form {
			margin: 0px;
			padding: 0px;
		}
		</style>
		<div class="layout vertical" id="main">
			<paper-material>
				<form id="searchbox_form">
					<paper-input no-label-float placeholder="Search anything..." value="{{searchword}}" id="searchbox_input">
						<paper-icon-button icon="search" prefix disabled id="searchbox_btn"></paper-icon-button>
					</paper-input>
				</form>
			</paper-material>
			<div id="results" class="flex">
			</div>
			<br /><br />
		</div>
	</template>
	<script>
	Polymer({
		is: "sidebar-element-browse",
		properties: {
			searchword: {
				type: String,
				notify: true,
				reflectToAttribute: true,
				observer: "inputChanged"
			},
			selectedresult: {
				type: String,
				reflectToAttribute: true,
				readOnly: true
			},
			locked: Boolean // Unused
		},
		listeners: {
			"cell-clicked": "search"
		},
		ready: function(e) {
			this.$.searchbox_form.addEventListener("submit", (function(e) {
				e.preventDefault();
			}).bind(this));
			this.$.searchbox_btn.addEventListener("click", (function(e) {
				this.$.searchbox_input.inputElement.readOnly = false;
				this.searchword = "";
				this.$.searchbox_btn.icon = "search";
				this.$.searchbox_btn.disabled = true;
				this.locked = false;
			}).bind(this));
		},
		inputChanged: function(value, prev) {
			// Force search
			if (value != prev) {
				this.search(value, 'input');
			}
		},
		search: function(key) {
			if (key instanceof Event) {
				key = key.detail.keyword;
				if (catalog.getCourse(key)) {
					this.fire('course-select', {code: key});
				}
				this.searchword = key;
				return;
			}
			if (key.length == 0) {
				this.populateDepts();
				return;
			}
			if (catalog.courses[key.toUpperCase()]) {
				this.populateDept(key.toUpperCase());
				return;
			}
			if (catalog.getCourse(key)) {
				var course = catalog.getCourse(key);
				this.$.results.innerHTML = '';
				var cell = generateCourseCell(course);
				Polymer.dom(this.$.results).appendChild(cell);
				this.fire('course-select', {code: key});
				return;
			}
			// Perform search
			var dept_result = [];
			var course_result = [];
			for (var dept in catalog.courses) {
				var deptobj = catalog.courses[dept];
				var rel = relevance(deptobj.name, key)
				if (rel)
					dept_result.push({dept, rel});
				for (var cnum in deptobj) {
					if (cnum == 'name')
						continue;
					var rel = relevance(deptobj[cnum].title, key);
					if (rel) {
						course_result.push({course:deptobj[cnum],rel});
					}
				}
			}
			dept_result.sort((a,b) => {
				return a.rel-b.rel;
			});
			course_result.sort((a,b) => {
				return a.rel-b.rel;
			});
			// Display results
			this.$.results.innerHTML = '';
			dept_result.forEach(((item) => {
				var cell = document.createElement('sidebar-search-result-cell');
				cell.caption = item.dept;
				cell.description = catalog.courses[item.dept].name;
				cell.owner = this;
				Polymer.dom(this.$.results).appendChild(cell);
			}).bind(this));
			course_result.forEach(((item) => {
				var cell = generateCourseCell(item.course);
				cell.owner = this;
				Polymer.dom(this.$.results).appendChild(cell);
			}).bind(this));
		},
		populateDepts: function() {
			this.$.results.innerHTML = '';
			for (var dept_code in catalog.courses) {
				var dept = catalog.courses[dept_code];
				var cell = document.createElement('sidebar-search-result-cell');
				cell.caption = dept_code;
				var course_count = Object.keys(dept).length-1; // Exclude the `name` property
				var description = `${dept.name}<br />\n${course_count} course`;
				if (course_count > 1)
					description += 's'; // Plural
				cell.description = description;
				cell.owner = this;
				Polymer.dom(this.$.results).appendChild(cell);
			}
		},
		populateDept: function(dept) {
			this.$.results.innerHTML = '';
			for (var course_no in catalog.courses[dept]) {
				var course = catalog.courses[dept][course_no];
				if (!course.code) {
					// Skip the name property
					continue;
				}
				var cell = generateCourseCell(course);
				cell.owner = this;
				Polymer.dom(this.$.results).appendChild(cell);
			}
		}
	});
	</script>

</dom-module>
</html>
