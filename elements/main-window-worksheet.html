<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-styles/color.html">

<link rel="import" href="main-section-info.html">

<script type="text/javascript" src="palette.js"></script>

<script type="text/javascript">
/**
 *	Worksheet data model
 *
 *	Associative arrays indexed by CRN
 *
 *	- status: CRN mapped to a string value from the following
 *		- `available`: Selectable
 *		- `selected`: Selected
 *		- `conflict`: Disabled because of another selected section
 *	- courses: CRN mapped to the course code
 */

try {
	var worksheet = localStorage.getItem("worksheet");
	if (!worksheet) {
		throw "Item does not exist in localStorage";
	}
	worksheet = JSON.parse(worksheet);
} catch(e) {
	worksheet = {};
}
var saveWorkSheet = function() {
	localStorage.putItem("worksheet", JSON.stringify(worksheet));
}
</script>

<style is="custom-style">
:root{
	paper-toolbar{
		--paper-toolbar-title:{
			font-size:20pt;
			height:auto;
		};
	}
}
</style>

<dom-module id="worksheet-section">
	<template>
		<style type="text/css">
			:host {
				display: inline-block;
				position: relative;
				bottom: 0px;
				left: 0px;
				width: 0px;
				height: 100%;
			};
			#container {
				position: relative;
				transform-origin: left bottom;
				height: 100%;
				user-select: none;
				-webkit-user-select: none;
			}
			#container>span {
				display: inline-block;
				position: relative;
				top: calc(50% - 0.5em); /* Align to middle */
				width: 100%;
				text-align: center;
			}
			#container>span#legend {
				text-align: left;
				top: calc(100% - 1em); /* Align to bottom */
				color: #ccc;
				transform: scale(0.7,0.7);
			}
		</style>
		<paper-material id="container" elevation="0">
			<span>[[caption]]</span>
			<paper-ripple noink="[[disabled]]"></paper-ripple>
		</paper-material>
	</template>
	<script type="text/javascript">
	Polymer({
		is: "worksheet-section",
		properties: {
			dept: {
				type: String,
				reflectToAttribute: true,
				notify: true,
				observer: "setDept"
			},
			begin: {
				type: String,
				reflectToAttribute: true,
				notify: true,
				observer: "setBeginTime"
			},
			end: {
				type: String,
				reflectToAttribute: true,
				notify: true,
				observer: "setEndTime"
			},
			caption: {
				type: String,
				reflectToAttribute: true
			},
			color: String,
			selected: {
				type: Boolean,
				reflectToAttribute: true,
				notify: true,
				observer: "setSelected"
			},
			disabled: {
				type: Boolean,
				reflectToAttribute: true,
				value: false,
				notify: true,
				observer: "setDisabled"
			},
			crn: {
				type: String,
				reflectToAttribute: true,
				notify: true,
				observer: "setCRN"
			}
		},
		setDisabled: function(disabled) {
			if (disabled) {
				if (this.dept != "LEGEND") {
					this.$.container.style.background = palette["--paper-grey-200"];
					this.$.container.style.color = palette["--paper-grey-400"];
				}
			} else {
				this.setSelected(this.selected);
			}
		},
		setSelected: function(selected) {
			if (selected instanceof Event) {
				this.selected = !this.selected;
				this.fire("section-selected", {
					selected: this.selected,
					crn: this.crn
				});
				return;
			}
			if (this.disabled) {
				return;
			}
			if (selected) {
				this.$.container.style.background = palette["--paper-"+this.color+"-500"];
				this.$.container.style.color = "#fff";
				this.style.zIndex = "3";
			} else {
				this.$.container.style.background = palette["--paper-"+this.color+"-100"];
				this.$.container.style.color = "#000";
				this.style.zIndex = "";
			}
		},
		setCRN: function(crn) {
			if (crn) {
				this.disabled = false;
			} else {
				this.disabled = true;
			}
		},
		setBeginTime: function(time) {
			var parts = time.split(':');
			if (parts.length != 3) {
				console.warn('Cannot parse time: '+time);
				return false;
			}
			time = (parts[0]/1) + (parts[1]/60) + (parts[2]/3600);
			this._beginTime = time;
			var left = (time - 8) * 4; // 4em per hour
			this.$.container.style.left = left+"em";
		},
		setEndTime: function(time) {
			var parts = time.split(':');
			if (parts.length != 3) {
				console.warn('Cannot parse time: '+time);
				return false;
			}
			time = (parts[0]/1) + (parts[1]/60) + (parts[2]/3600);
			time += 10/3600; // Align End
			this._endTime = time;
			var width = (time - this._beginTime) * 4; // 4em pixels per hour
			this.$.container.style.width = width+"4em";
		},
		setDept: function(dept) {
			this.$.container.style.transform = "";
			this.$.container.style.color = "";
			this.$.container.querySelector("span").id="";
			this.disabled = true;
			this.disabled = false;
			if (catalog.courses[dept]) {
				this.$.container.elevation = 1;
				for (var k in catalog.courses[dept]) {
					this.color = catalog.courses[dept][k].getColor();
					this.setSelected(this.selected);
					break;
				}
				this.disabled = false;
			} else if (dept == 'DISABLED') {
				// Disabler
				this.$.container.elevation = 0;
				this.$.container.style.background = "#ccc";
				this.disabled = true;
			} else if (dept == 'LEGEND') {
				// Time legend
				this.$.container.elevation = 0;
				this.$.container.style.background = "";
				this.$.container.querySelector("span").id="legend";
				this.disabled = true;
			} else {
				this.$.container.elevation = 1;
				this.$.container.style.background = "#fff";
				this.disabled = false;
			}
		},
		ready: function() {
			this.listen(this.$.container, "tap", "setSelected");
		}
	});
	</script>
</dom-module>

<dom-module id="main-window-worksheet">
	<template>
		<style type="text/css">
			:host {
				font-family: sans-serif;
				overflow-x: auto;
			}
			#container {
				height: calc(100% - 64px);
				overflow: auto;
			}
			#tbody {
				height: calc(100% - 6em - 1px);
				overflow-y: auto;
				display: inline-block;
			}
			td, th {
				white-space: nowrap;
			}
			table {
				border-collapse: collapse;
			}
			tr {
				border-bottom: solid #ccc 1px;
				transition: background 0.5s;
			}
			tr:hover {
				background: var(--paper-grey-200);
			}
			td, th {
				border: none;
				border-right: 1px dashed #ccc;
				text-align: left;
				height: 3em;
				overflow: hidden;
			}
			#thead th .td-day {
				/* For ripples */
				position: relative;
				text-align: center;
				cursor: pointer;
				user-select: none;
				-webkit-user-select: none;
			}
			#thead .td-day span {
				/* Center text vertically */
				display: inline-block;
				position: relative;
				top: calc(50% - 0.7em);
			}
			.td-day {
				text-align: left;
				transition: width 0.5s;
				width: 40em; /* 4em*(18-8) */
				overflow: hidden;
				height: 100%;
			}
			.td-day.td-fullwidth {
				width: 52em; /* 4em*(21-8) */
			}
			.td-name {
				position: relative;
				cursor: pointer;
				width: 12em;
				height: 100%;
				user-select: none;
				-webkit-user-select: none;
			}
			.td-name code {
				/* Center text vertically */
				display: inline-block;
				position: relative;
				top: calc(50% - 0.7em);
				left: 2em;
			}
			.td-name strong {
			}
			.td-name i {
				font-size: 0.8em;
				color: #666;
			}
		</style>
		<paper-header-panel mode="waterfall" shadow>
			<paper-toolbar id="header">
				<div class="title">Timetable Worksheet</div>
			</paper-toolbar>
			<div id="container">
				<div id="thead">
					<table>
						<tr>
							<th><div id="th-name" class="td-name">&nbsp;</div></th>
							<th><div id="th-m" class="td-day td-m">
								<span>MON</span>
								<paper-ripple></paper-ripple>
							</div></th>
							<th><div id="th-t" class="td-day td-t">
								<span>TUE</span>
								<paper-ripple></paper-ripple>
							</div></th>
							<th><div id="th-w" class="td-day td-w">
								<span>WED</span>
								<paper-ripple></paper-ripple>
							</div></th>
							<th><div id="th-r" class="td-day td-r">
								<span>THU</span>
								<paper-ripple></paper-ripple>
							</div></th>
							<th><div id="th-f" class="td-day td-f">
								<span>FRI</span>
								<paper-ripple></paper-ripple>
							</div></th>
							<tr>
								<td><div id="td-name" class="td-name">&nbsp;</div></td>
								<td><div id="td-m" class="td-day td-m"></div></td>
								<td><div id="td-t" class="td-day td-t"></div></td>
								<td><div id="td-w" class="td-day td-w"></div></td>
								<td><div id="td-r" class="td-day td-r"></div></td>
								<td><div id="td-f" class="td-day td-f"></div></td>
							</tr>
						</tr>
					</table>
				</div>
				<div id="tbody">
					<table>
						<tbody id="seclist">
						</tbody>
					</table>
				</div>
			</div>
		</paper-header-panel>
	</template>
	<script>
	Polymer({
		is: "main-window-worksheet",
		properties: {
		},
		ready: function() {
			// Inflate legends
			var days = "mtwrf";
			for (var d = 0; d < days.length; ++d) {
				for (var t = 8; t < 21; ++t) {
					var cell = document.createElement("worksheet-section");
					cell.begin = t+":00:00";
					cell.end = t+":50:00";
					cell.caption = t;
					cell.dept = "LEGEND";
					Polymer.dom(this.$["td-"+days[d]]).appendChild(cell);
				}
				this.$["th-"+days[d]].addEventListener("click", this.hideDay.bind(this, d));
			}
			this.updateBookmark();
		},
		hideDay: function(d) {
			var days = "mtwrf";
			if (this.$["th-"+days[d]].style.width == "") {
				// Hide
				this.querySelectorAll(".td-"+days[d]).forEach((item) => {
					item.style.width = "3em";
				});
			} else {
				// Show
				this.querySelectorAll(".td-"+days[d]).forEach((item) => {
					item.style.width = "";
				});
			}
		},
		hideCourse: function(course, type) {
			// course and type must be already sanitized!
			var master = this.$$(".tr-master.tr-"+course+"-"+type);
			// TODO: animation
			if (master.folded) {
				master.folded = false;
				// Expand
				this.$.tbody.querySelectorAll("tr.tr-detail.tr-"+course+"-"+type).forEach((item) => {
					item.style.display = "";
				});
			} else {
				// Hide
				master.folded = true;
				this.$.tbody.querySelectorAll("tr.tr-detail.tr-"+course+"-"+type).forEach((item) => {
					item.style.display = "none";
				});
			}
		},
		selectCRN: function(e) {
			e.detail.crn;
			e.detail.selected;
		},
		updateBookmark: function() {
			var days = "mtwrf";
			for (var course in bookmark.data) {
				for (var type in bookmark.data[course]) {
					var san_course = course.replace(/ /g, '');
					var san_type = type.replace(/\//g, '_').replace(/ /g, '');

					var secgroup = bookmark.data[course][type];
					var	courseobj = catalog.getCourse(course),
						secobj = courseobj.sections[type];

					var master_tr = document.createElement("tr");
					master_tr.className = "tr-"+san_course+"-"+san_type+" tr-master";
					master_tr.folded = true;

					var master_name = document.createElement("td");
					var master_namediv = document.createElement("div");
					master_namediv.innerHTML = `<strong>${course}</strong><br /><i>${type}</i>`;
					master_namediv.className = "td-name";
					Polymer.dom(master_namediv).appendChild(document.createElement("paper-ripple"));
					master_namediv.addEventListener("click", ((course, type) => {
						this.hideCourse(course, type);
					}).bind(this,san_course,san_type));
					Polymer.dom(master_name).appendChild(master_namediv);
					Polymer.dom(master_tr).appendChild(master_name);

					for (var i=0; i<days.length; ++i) {
						var day_cell = document.createElement("td");
						var day_div = document.createElement("div");
						day_div.className = "td-day td-"+days[i];
						Polymer.dom(day_cell).appendChild(day_div);
						Polymer.dom(master_tr).appendChild(day_cell);
					}
					Polymer.dom(this.$.seclist).appendChild(master_tr);
					// Insert all CRNs
					secobj.forEach((crnobj) => {
						var row = document.createElement("tr");
						row.className = "tr-detail tr-"+san_course+"-"+san_type;
						row.id = "tr-"+crnobj.crn;
						row.style.display = "none";

						var name_cell = document.createElement("td");
						var name_div = document.createElement("div");
						name_div.className = "td-name";
						name_div.innerHTML = `<code>${crnobj.section} (${crnobj.crn})</code>`;
						Polymer.dom(name_div).appendChild(document.createElement("paper-ripple"));
						name_div.addEventListener("click", ((crn)=>{
							this.selectCRN({
								detail: {
									crn: crn,
									selected: true
								}
							});
						}).bind(this,crnobj.crn));
						Polymer.dom(name_cell).appendChild(name_div);
						Polymer.dom(row).appendChild(name_cell);
						for (var i=0; i<days.length; ++i) {
							var day_cell = document.createElement("td");
							var day_div = document.createElement("div");
							day_div.className = "td-day td-"+days[i];
							Polymer.dom(day_cell).appendChild(day_div);
							Polymer.dom(row).appendChild(day_cell);
						}
						crnobj.meetings.forEach((meetobj) => {
							var	starttime = meetobj.time[0],
								endtime = meetobj.time[1];
							starttime = starttime.h+":"+starttime.m+":"+starttime.s;
							endtime = endtime.h+":"+endtime.m+":"+endtime.s;
							meetobj.day.forEach((day) => {
								// Decide whether this day is full width
								if (meetobj.time[1].h > 18) {
									this.querySelectorAll("div.td-"+day).forEach((daydiv) => {
										if (daydiv.className.indexOf("td-fullwidth")==-1) {
											daydiv.className += " td-fullwidth";
										}
									});
								}
								day = day.toLowerCase();
								var sec = document.createElement("worksheet-section");
								sec.begin = starttime;
								sec.end = endtime;
								sec.dept = courseobj.dept;
								sec.caption = crnobj.section;
								Polymer.dom(row.querySelector("div.td-"+day)).appendChild(sec);
								Polymer.dom(master_tr.querySelector("div.td-"+day)).appendChild(sec.cloneNode(true));
							});

						});
						Polymer.dom(this.$.seclist).appendChild(row);
					});
				}
			}
		}
	});
	</script>

</dom-module>
</html>
