"use strict";

var WebViewManager = function(host, webview) {
	this.webview = webview;
	this.host = host;
	webview.addEventListener("did-finish-load", (e) => {
		// webview = e.target;
		if (webview.src.indexOf("https://eas.admin.uillinois.edu/eas/servlet/EasLogin")==0) {
			this.login();
			return;
		}
		if (webview.src.indexOf("https://ui2web1.apps.uillinois.edu/BANPROD1/twbkwbis.P_GenMenu?name=bmenu.P_MainMnu")==0) {
			this.success("Login successful. Ready for RegD");
			// this.regHome();
			return;
		}
		if (webview.src.indexOf("https://ui2web1.apps.uillinois.edu/BANPROD1/bwskflib.P_SelDefTerm")==0) {
			this.initTerm();
			return;
		}
		if (webview.src.indexOf("https://ui2web1.apps.uillinois.edu/BANPROD1/twbkwbis.P_GenMenu?name=bmenu.P_RegAgreementLook")==0) {
			this.agreeTerms();
			return;
		}
		if (webview.src.indexOf("https://ui2web1.apps.uillinois.edu/BANPROD1/bwskfcls.p_sel_crse_search")==0) {
			this.courseSearchSelectTerm();
			return;
		}
		if (webview.src.indexOf("https://ui2web1.apps.uillinois.edu/BANPROD1/bwckgens.p_proc_term_date")==0) {
			this.courseSearchSelectDept();
			return;
		}
		if (webview.src.indexOf("https://ui2web1.apps.uillinois.edu/BANPROD1/bwskfcls.P_GetCrse")==0) {
			this.webview.executeJavaScript(`
				document.querySelector("input[name=SUB_BTN]");`, false, (e) => {
					if (e) {
						this.courseSearchSelectCourse();
					} else {
						this.courseSearchParseResults();
					}
				});
			return;
		}
	});
	webview.src = "https://webprod.admin.uillinois.edu/ssa/servlet/SelfServiceLogin?appName=edu.uillinois.aits.SelfServiceLogin&dad=BANPROD1";

	/*
	this.msg = function (type, msg) {
		if (type != "info")
			this.host.div.className = "panel panel-"+type;

		this.host.statusDiv.className = "alert alert-"+type;
		this.host.statusDiv.innerText = msg;
	};
	*/
	this.msg = host.msg;
	this.log = this.msg.bind(this, "info");
	this.warn = this.msg.bind(this, "warning");
	this.error = this.msg.bind(this, "danger");
	this.success = this.msg.bind(this, "success");

	this.login = function() {
		if (!this.host.pref.autologin) {
			alert("Please authenticate into Enterprise in Settings/Enterprise Interface");
			return;
		}
		webview.executeJavaScript(`
			var errmsg = document.querySelector("#attentionText");
			if (errmsg) {errmsg.innerText;} else {false;}`, false, (e) => {
				if (e) {
					this.error(e);
				} else {
					webview.executeJavaScript(`
						document.querySelector("#ENT_ID").value = "${this.host.username}";
						document.querySelector("#PASSWORD").value = "${this.host.password}";
						document.querySelector("input[type=submit]").click();`);
				}
		});
	};

	this.regHome = function() {
		this.webview.src="https://ui2web1.apps.uillinois.edu/BANPROD1/bwskflib.P_SelDefTerm";
	};
	this.initTerm = function() {
		this.webview.executeJavaScript(`document.querySelector("select#term_id").selectedOptions[0].innerText`,
			false, (e) => {
				this.success(`Ready for registration at ${e.trim()}`);
				this.webview.executeJavaScript(`document.querySelector("select#term_id").form.submit()`);
		});
	};
	this.agreeTerms = function() {
		this.webview.executeJavaScript(`
			document.querySelectorAll("a").forEach((item) => {
				if (item.innerText.trim().toLowerCase().indexOf("i agree")==0) {
					item.click();
				}
			});`);
	};
	this.courseSearchSelectTerm = function() {
		this.webview.executeJavaScript(`
			document.querySelector("select[name=p_term]").selectedIndex = 1;
			document.querySelector("select[name=p_term]").form.submit();`);
	}

	this.courseSearchSelectDept = function() {
		this.webview.executeJavaScript(`
			var found = true;
			if (!document.querySelector("option[value=${this.order.dept}]")) {
				found = false;
			} else {
				document.querySelector("select#subj_id").value = "${this.order.dept}";
				document.querySelector("select#subj_id").form.querySelector("input[type=submit]").click();
			}
			found;`, false, (found) => {
			if (!found) {
				// Dept not found
				this.order.reject("Dept not found");
				this.order = false;
			}
		});
	};

	this.courseSearchSelectCourse = function() {
		this.webview.executeJavaScript(`
			var found = false;
			document.querySelectorAll("tr").forEach((row) => {
				if (row.cells.length == 3 && row.cells[0].innerText=="${this.order.num}") {
					found = true;
					row.cells[2].querySelector("form").querySelector("input[type=submit").click();
				}
			});
			found;`, false, (found) => {
			if (!found) {
				// Course not found
				this.order.reject("Course not found");
				this.order = false;
			}
		});
	};

	this.courseSearchParseResults = function() {
		this.webview.executeJavaScript(`
			var result = {};
			document.querySelectorAll("tr").forEach((row) => {
				if (row.cells.length == 23) {
					var crn = parseInt(row.cells[1].innerText);
					if (!(crn > 0)) {
						return;
					}
					result[crn] = {
						"cap": parseInt(row.cells[10].innerText),
						"act": parseInt(row.cells[11].innerText),
						"rem": parseInt(row.cells[12].innerText),
						"xlcap": parseInt(row.cells[16].innerText),
						"xlact": parseInt(row.cells[17].innerText),
						"xlrem": parseInt(row.cells[18].innerText),
						"instr": row.cells[19].innerText
					};
				}
			});
			result`, false, (result) => {
				this.order.resolve(result);
				this.order = false;
			});
	};

	this.getCourseSeats = function(dept, num) {
		if (this.order) {
			return Promise.reject("Another order in progress");
		}
		this.order = {dept, num};
		var promise = new Promise((resolve, reject) => {
			this.order.resolve = resolve;
			this.order.reject = reject;
		});
		// Perform search
		this.webview.src="https://ui2web1.apps.uillinois.edu/BANPROD1/twbkwbis.P_GenMenu?name=bmenu.P_RegAgreementLook";
		return promise;
	};
};

module.exports = WebViewManager;
