"use strict";

function WebViewManager(host, webview) {
	this.webview = webview;
	this.wvctx = webview.getWebContents();
	this.host = host;
	webview.addEventListener("did-finish-load", (e) => {
		// webview = e.target;
		if (webview.src.startsWith("https://eas.admin.uillinois.edu/eas/servlet/EasLogin")) {
			this.login();
			return;
		}
		if (webview.src.startsWith("https://ui2web1.apps.uillinois.edu/BANPROD1/twbkwbis.P_GenMenu?name=bmenu.P_MainMnu")) {
			this.success("Login successful. Ready for RegD");
			// this.regHome();
			return;
		}
		if (webview.src.startsWith("https://ui2web1.apps.uillinois.edu/BANPROD1/bwskflib.P_SelDefTerm")) {
			this.initTerm();
			return;
		}
		if (webview.src.startsWith("https://ui2web1.apps.uillinois.edu/BANPROD1/twbkwbis.P_GenMenu?name=bmenu.P_RegAgreement")) {
			this.agreeTerms();
			return;
		}
		if (webview.src.startsWith("https://ui2web1.apps.uillinois.edu/BANPROD1/bwskfcls.p_sel_crse_search")) {
			this.courseSearchSelectTerm();
			return;
		}
		if (webview.src.startsWith("https://ui2web1.apps.uillinois.edu/BANPROD1/bwckgens.p_proc_term_date")) {
			this.courseSearchSelectDept();
			return;
		}
		if (webview.src.startsWith("https://ui2web1.apps.uillinois.edu/BANPROD1/bwskfcls.P_GetCrse")) {
			this.wvctx.executeJavaScript(`
				document.querySelector("input[name=SUB_BTN]");`).then((e) => {
					if (e) {
						this.courseSearchSelectCourse();
					} else {
						this.courseSearchParseResults();
					}
				});
			return;
		}
		if (webview.src.startsWith("https://ui2web1.apps.uillinois.edu/BANPROD1/bwskfreg.P_AltPin")) {
			this.addDropExecute();
		}
		if (webview.src.startsWith("https://ui2web1.apps.uillinois.edu/BANPROD1/bwckschd.p_disp_detail_sched")) {
			this.parseCRNDetail();
		}
	});

	this.easlogin = () => {
		webview.src = "https://webprod.admin.uillinois.edu/ssa/servlet/SelfServiceLogin?appName=edu.uillinois.aits.SelfServiceLogin&dad=BANPROD1";
	}

	this.easlogin();

	/*
	this.msg = function (type, msg) {
		if (type != "info")
			this.host.div.className = "panel panel-"+type;

		this.host.statusDiv.className = "alert alert-"+type;
		this.host.statusDiv.innerText = msg;
	};
	*/
	this.msg = host.msg;
	this.log = this.msg.bind(this, "info");
	this.warn = this.msg.bind(this, "warning");
	this.error = this.msg.bind(this, "danger");
	this.success = this.msg.bind(this, "success");

	this.login = () => {
		if (!this.host.pref.autologin) {
			alert("Please authenticate into Enterprise in Settings/Enterprise Interface");
			return;
		}
		this.wvctx.executeJavaScript(`
			var errmsg = document.querySelector("#attentionText");
			if (errmsg) {errmsg.innerText;} else {false;}`).then((e) => {
				if (e) {
					this.error(e);
				} else {
					this.wvctx.executeJavaScript(`
						document.querySelector("#netid").value = "${this.host.pref.username}";
						document.querySelector("#easpass").value = "${this.host.pref.password}";
						document.querySelector("input[type=submit]").click();`);
				}
		});
	};

	this.regHome = () => {
		this.webview.src="https://ui2web1.apps.uillinois.edu/BANPROD1/bwskflib.P_SelDefTerm";
	};
	this.initTerm = () => {
		this.wvctx.executeJavaScript(`
			let term = document.querySelector("select#term_id").selectedOptions[0];
			let result = {};
			result.name = term.innerText.trim();
			result.id = term.value;
			result;`).then((e) => {
				this.success(`Ready for registration at ${e.name}`);
				this.semid = e.id;
				this.wvctx.executeJavaScript(`document.querySelector("select#term_id").form.submit()`);
		});
	};
	this.agreeTerms = () => {
		this.wvctx.executeJavaScript(`
			document.querySelectorAll("a").forEach((item) => {
				if (item.innerText.trim().toLowerCase().indexOf("i agree")==0) {
					item.click();
				}
			});`);
	};
	this.courseSearchSelectTerm = () => {
		this.wvctx.executeJavaScript(`
			document.querySelector("select[name=p_term]").selectedIndex = 1;
			document.querySelector("select[name=p_term]").form.submit();`);
	}

	this.courseSearchSelectDept = () => {
		if (!this.order)
			return;
		this.wvctx.executeJavaScript(`
			var found = true;
			if (!document.querySelector("option[value=${this.order.dept}]")) {
				found = false;
			} else {
				document.querySelector("select#subj_id").value = "${this.order.dept}";
				document.querySelector("select#subj_id").form.querySelector("input[type=submit]").click();
			}
			found;`).then((found) => {
			if (!found) {
				// Dept not found
				let reject = this.order.reject;
				this.order = null;
				reject(new Error("Dept not found"));
			}
		});
	};

	this.courseSearchSelectCourse = () => {
		if (!this.order)
			return;
		this.wvctx.executeJavaScript(`
			var found = false;
			document.querySelectorAll("tr").forEach((row) => {
				if (row.cells.length == 3 && row.cells[0].innerText=="${this.order.num}") {
					found = true;
					row.cells[2].querySelector("form").querySelector("input[type=submit").click();
				}
			});
			found;`, false, found => {
			if (!found) {
				// Course not found
				let reject = this.order.reject;
				this.order = null;
				reject(new Error("Course not found"));
			}
		});
	};

	this.courseSearchParseResults = () => {
		if (!this.order)
			return;
		this.wvctx.executeJavaScript(`
			var result = {};
			document.querySelectorAll("tr").forEach((row) => {
				if (row.cells.length == 23) {
					var crn = parseInt(row.cells[1].innerText);
					if (!(crn > 0)) {
						return;
					}
					result[crn] = {
						"cap": parseInt(row.cells[10].innerText),
						"act": parseInt(row.cells[11].innerText),
						"rem": parseInt(row.cells[12].innerText),
						"xlcap": parseInt(row.cells[16].innerText),
						"xlact": parseInt(row.cells[17].innerText),
						"xlrem": parseInt(row.cells[18].innerText),
						"instr": row.cells[19].innerText
					};
				}
			});
			result`).then(result => {
				let resolve = this.order.resolve;
				this.order = null;
				resolve(result);
			}).catch(e => {
				let reject = this.order.reject;
				this.order = null;
				reject(e);
			});
	};

	this.addDropExecute = () => {

	};

	this.parseCRNDetail = () => {
		if (!this.order)
			return;
		this.wvctx.executeJavaScript(`
			var mainblk = null, seatblk = null;
			document.querySelectorAll("caption").forEach(el => {
				if (el.innerText.toLowerCase().indexOf("detailed class information") >= 0) {
					mainblk = el.parentElement.querySelector(".dddefault");
				} else if (el.innerText.toLowerCase().indexOf("registration availability") >= 0) {
					seatblk = el.parentElement;
				}
			});
			if (!mainblk || !seatblk) {
				throw new Error("Malformed CRN detail page");
			}

			// Gather seat information
			let seats = {};
			let seatrows = seatblk.querySelectorAll("tr");
			let seatent = seatrows[1].querySelectorAll("td");
			seats["cap"] = parseInt(seatent[0].innerText);
			seats["act"] = parseInt(seatent[1].innerText);
			seats["rem"] = parseInt(seatent[2].innerText);
			seatent = seatrows[2].querySelectorAll("td");
			seats["wlcap"] = parseInt(seatent[0].innerText);
			seats["wlact"] = parseInt(seatent[1].innerText);
			seats["wlrem"] = parseInt(seatent[2].innerText);
			seatent = seatrows[3].querySelectorAll("td");
			seats["xlcap"] = parseInt(seatent[0].innerText);
			seats["xlact"] = parseInt(seatent[1].innerText);
			seats["xlrem"] = parseInt(seatent[2].innerText);

			// Gather restrictions information
			let ents = mainblk.childNodes;
			let restrictions = {}, restr_category = null;
			let i = 0;
			for (; i < ents.length; i++) {
				if (!ents[i].textContent)
					continue;
				let text = ents[i].textContent.trim().toLowerCase();
				if (text == "restrictions:")
					break;
			}
			if (i >= ents.length) {
				throw new Error("Cannot find restrictions block");
			}
			for (i++; i < ents.length; i++) {
				if (!ents[i].textContent)
					continue;
				let text = ents[i].textContent.trim().toLowerCase();
				if (text.length == 0)
					continue;
				if (text.startsWith("must ")) {
					if (text.indexOf("enrolled in one of the following majors") > 0) {
						restr_category = "major";
					} else if (text.indexOf("assigned to one of the following cohorts") > 0) {
						restr_category = "cohort";
					} else if (text.indexOf("enrolled in one of the following levels") > 0) {
						restr_category = "level";
					} else {
						console.warn("Unknown category: "+text);
						continue;
					}
					restrictions[restr_category] = [];
				} else if (restr_category) {
					restrictions[restr_category].push(text);
				}
			}
			let result = {seats, restrictions};
			result`).then(result => {
				let resolve = this.order.resolve;
				this.order = null;
				resolve(result);
			}).catch(e => {
				reject = this.order.reject;
				this.order = null;
				reject(e);
			});
	};

	this.getCRNDetail = (crn) => {
		this.order = {};
		var promise = new Promise((resolve, reject) => {
			this.order.resolve = resolve;
			this.order.reject = reject;
		});
		this.webview.src = `https://ui2web1.apps.uillinois.edu/BANPROD1/bwckschd.p_disp_detail_sched?term_in=${this.semid}&crn_in=${crn}`;
		return promise;
	};

	this.getCourseSeats = (dept, num) => {
		if (this.order) {
			return Promise.reject("Another order in progress");
		}
		this.order = {dept, num};
		var promise = new Promise((resolve, reject) => {
			this.order.resolve = resolve;
			this.order.reject = reject;
		});
		// Perform search
		this.webview.src="https://ui2web1.apps.uillinois.edu/BANPROD1/twbkwbis.P_GenMenu?name=bmenu.P_RegAgreementLook";
		return promise;
	};
};

module.exports = WebViewManager;
