"use strict";

const Course = require('course');

// IO proxies
const ioutils = require('ioutils');
const json_io = ioutils.json_io;
const fs_io = ioutils.fs_io;
const http_io = ioutils.http_io;

// Utilities
const utils = require('utils');
const html2document = utils.html2document;
const html2text = utils.html2text;

// The Catalog

var Catalog = function(depts, courses, term) {
	// Index courses into the catalog object
	this.courses = {};
	this.term = term;
	for (var dept in depts) {
		this.courses[dept] = {name:depts[dept]};
	}
	courses.forEach((course) => {
		let dept = course.dept;
		if (!this.courses[dept]) {
			console.warn(`Dept ${dept} not indexed!`);
			this.courses[dept] = {name: dept};
		}
		this.courses[dept][course.number] = course;
	});

	this.getCourse = function(code) {
		var code = Catalog.parseCourseCode(code);
		if (!code || !this.courses[code.dept] || !this.courses[code.dept][code.number]) {
			return null;
		}
		return this.courses[code.dept][code.number];
	}

	this.resolveDependencies = function() {
		// TODO
	}

	this.update = function(code) {
		return new Promise((resolve, reject) => {
			code = Catalog.parseCourseCode(code);
			if (!code) {
				reject("Invalid course code");
				return;
			}
			console.log(code);
			console.log("https://courses.illinois.edu/schedule/"+this.term+"/"+code.dept+"/"+code.number);
			// TODO: embed base urls into data
			Course.fromURL("https://courses.illinois.edu/schedule/"+this.term+"/"+code.dept+"/"+code.number).then((course) => {
				this.course[code.dept][code.number] = course;
				if (this.storage) {
					storage.setItem(`${code.dept}_${code.number}`, JSON.stringify(course));
				}
				console.log("Resolved");
				console.log(course);
				resolve(course);
			}, (err) => {
				console.error(err);
				reject(err);
			});
		});
	}

	// Dump to filesystem/localstorage
	this.save = function(storage) {
		if (!storage) {
			if (!this.storage) {
				return false;
			}
			storage = this.storage;
		}
		let index = [], dept_index = {};
		for (var dept_code in this.courses) {
			let dept = this.courses[dept_code];
			for (var idx in dept) {
				if (idx == 'name') {
					dept_index[dept_code] = dept[idx];
				} else {
					let course = dept[idx], filename = `${dept_code}_${course.number}`;
					index.push(filename);
					storage.setItem(filename, JSON.stringify(course));
				}
			}
		}
		storage.setItem("index", JSON.stringify(index));
		storage.setItem("depts", JSON.stringify(dept_index));
		storage.setItem("meta", JSON.stringify({term: this.term}));
	}

	return this;
};

// Online-fetch utilities
let getTerm = function(term, io) {
	return new Promise((resolve, reject) => {
		io.getItem('schedule/'+term).then((val) => {
			let table = html2document(val).querySelector("table#term-dt tbody");
			if (!table) {
				throw `Cannot get dept list for term ${term}`;
			}

			var depts = {}, dept_list = [], courses = [], ptr = 0;

			var dept_promise = Promise.resolve();

			table.querySelectorAll("tr").forEach((dept) => {
				let tds = dept.querySelectorAll('td');
				if (tds.length != 2) {
					console.warn(`Unexpected td length for ${dept}`);
					return;
				}
				let	dept_code = tds[0].innerText.trim().toUpperCase(),
					dept_name = tds[1].innerText.trim(),
					dept_link = dept.querySelector('a').getAttribute('href');
				if (!dept_link) {
					console.warn(`No link to ${dept_code}, skipping...`);
					return
				}
				depts[dept_code] = dept_name;
				dept_list.push({dept_name, dept_link});

				dept_promise = dept_promise.then(() => {
					return getCoursesForDept(dept_list[ptr].dept_link, io);
				}).then((val) => {
					courses = courses.concat(val);
					ptr++;
				}, (err) => {
					console.warn(`Course fetch failed for ${dept_list[ptr].dept_name}`);
					console.warn(err);
					ptr++;
				});
			});

			dept_promise.then(() => {
				resolve({courses, depts});
			});
		}, (err) => {
			reject(err);
		});
	});
};

let getCoursesForDept = function(url, io) {
	return new Promise((resolve, reject) => {
		io.getItem(url).then((val) => {
			let table = html2document(val).querySelector('table#default-dt tbody');
			var q = [[],[],[],[]], ptr = 0; // 4 Concurrent connections
			var promises = [Promise.resolve(), Promise.resolve(), Promise.resolve(), Promise.resolve()];
			var courses = [];
			q.io = io;
			table.querySelectorAll('a').forEach((item) => {
				q[ptr].push(item.getAttribute('href'));

				promises[ptr] = promises[ptr].then( ( (i)=>{
					return Course.fromURL(q[i].pop(), io);
				} ).bind(this, ptr) );
				promises[ptr] = promises[ptr].then((fetched_course) => {
					courses.push(fetched_course);
				}, (err) => {
					console.warn("Cannot process course");
					console.warn(err);
				});

				++ptr;
				ptr%=4;
			});
			Promise.all(promises).then(() => {
				// console.log(`Fetched ${courses.length} courses for ${url}`);
				resolve(courses);
			});
		});
	});
}

// Initialization class methods

Catalog.fromTerm = function(term, baseURL) {
	if (!baseURL) {
		baseURL = "https://courses.illinois.edu/";
	}
	if (!term) {
		term = "2017/spring";
	}
	var io = new http_io(baseURL);
	return new Promise((resolve, reject) => {
		getTerm(term, io).then((val) => {
			try {
				var catalog = new Catalog(val.depts, val.courses, term);
				catalog.resolveDependencies();
				resolve(catalog);
			} catch(e) {
				reject(e);
			}
		}, (err) => {
			reject(err);
		});
	});
}

Catalog.fromStorage = function(storage) {
	if (!storage) {
		throw "Storage object unavailable";
	}
	let index = JSON.parse(storage.getItem('index'));
	let depts = JSON.parse(storage.getItem('depts'));
	let meta = JSON.parse(storage.getItem('meta'));
	var courses = [];
	index.forEach((file) => {
		let data = JSON.parse(storage.getItem(file));
		courses.push(new Course(data));
	});

	let catalog = new Catalog(depts, courses, meta.term);
	catalog.storage = storage;
	return catalog;
}

Catalog.fromLocalStorage = Catalog.fromStorage.bind({}, window.localStorage);

Catalog.fromDirectory = function(dirname) {
	return Catalog.fromStorage(new fs_io(dirname));
}

// Utility methods

Catalog.parseCourseCode = function(courseid) {
	try {
		var number = parseInt(/\d+/.exec(courseid)[0]);
		if (number < 100) {
			throw "Course number too low";
		}
		var dept = /[A-Za-z]*/.exec(courseid)[0].toUpperCase();
		return {dept, number};
	} catch(e) {
		return null;
	}
}

module.exports = Catalog;
window.Catalog = Catalog;
